# Code Audit and Improvements (2026-02-06)

## Scope

Performed a full code pass over CLI, GUI, domain modules, save system, and tests.
Implemented behavior and reliability improvements without changing the core game loop concept.

## Implemented Improvements

### 1. Input and State Validation

- Enforced non-empty boxer names during creation.
- Normalized nationality input (`""` now defaults to `"USA"`).
- Added month-advance validation to reject negative month steps.
- Hardened career state deserialization for invalid month/year values.

Files:
- `boxing_game/modules/player_profile.py`
- `boxing_game/modules/career_clock.py`
- `boxing_game/models.py`

### 2. Legacy Save Migration and Save Compatibility

- Save format now writes `version: 2`.
- Loader now rejects unsupported future save versions with a clear error.
- Added compatibility migration for legacy saves without `career_months`:
  - infers career months from `month/year`
  - backfills age progression baseline from inferred elapsed time

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/models.py`

### 3. Pro Ranking Logic Reliability

- Removed hardcoded rank ceiling assumptions.
- Ranking updates now honor each organization's configured `ranking_slots`.
- Pro ranking state normalization now:
  - backfills missing organizations
  - repairs invalid `organization_focus` on load

Files:
- `boxing_game/modules/pro_career.py`

### 4. Finance/Purse Transparency

- Purse offers now include `total_expenses`.
- Added shared formatter for purse breakdown display.
- Updated CLI and GUI to display expanded purse details.

Files:
- `boxing_game/modules/pro_career.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`

### 5. Amateur/Pro Boundary Guards

- Amateur opponent generation now rejects pro-state careers.
- Existing amateur result guard remains in place.

Files:
- `boxing_game/modules/amateur_circuit.py`

### 6. GUI Startup UX

- Added explicit startup error message when PySide6 is missing, with install command.

Files:
- `boxing_game/gui.py`

### 7. Repository Hygiene

- Added `.gitignore` for Python cache files, virtual env/vendor folders, pytest cache, and local saves.

Files:
- `.gitignore`

### 8. Career Start Age Baseline

- Updated starting boxer age baseline from `18` to `16`.
- Applied baseline consistently to:
  - boxer creation
  - legacy age backfill/migration logic
  - age-related tests

Files:
- `boxing_game/constants.py`
- `boxing_game/modules/player_profile.py`
- `boxing_game/models.py`

### 9. Pro Eligibility Age Gate

- Added `min_age` support to pro readiness rules.
- Configured current gate to allow turning pro from age `19` onward (with fights/points still required).
- Added regression test for age-gated pro readiness.

Files:
- `rules/amateur_progression.json`
- `boxing_game/modules/amateur_circuit.py`
- `tests/test_pro_career.py`

### 10. Save Reliability and Readiness UX

- Save writes now use atomic replacement to reduce corruption risk.
- Save loading now reports clearer, normalized `SavegameError` messages for:
  - invalid JSON
  - invalid version field
  - invalid/malformed career payload
- Added structured readiness status (`age`, `fights`, `points`) and surfaced progress in CLI/GUI.
- Added validation to reject fight simulations with invalid round counts (`< 1`).

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `boxing_game/modules/fight_sim_engine.py`
- `tests/test_savegame.py`
- `tests/test_pro_career.py`
- `tests/test_amateur_flow.py`

### 11. Rankings Page and Boxer Rating

- Added a dedicated GUI rankings page with organization selector (`WBC/WBA/IBF/WBO`) and top-board display.
- Added deterministic ranking snapshot generation with player-row inclusion (ranked/unranked cases).
- Added weighted overall boxer rating and displayed it on boxer profile views.

Files:
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/rating_engine.py`
- `boxing_game/gui.py`
- `boxing_game/game.py`
- `tests/test_pro_career.py`

### 12. Fight Experience Progression

- Added a dedicated experience model (`rules/experience_model.json`) with:
  - stage-specific XP gain (`amateur` vs `pro`)
  - outcome weighting (`win/draw/loss`)
  - KO/TKO bonus
  - configurable level thresholds and in-fight experience bonus
- Added `experience_engine` module for:
  - XP gain calculation
  - XP profile resolution (level/title/next threshold)
  - inferred XP for legacy states using total fight count
- Wired experience gain into both amateur and pro fight-result pipelines.
- Integrated experience bonus into fight simulation and overall rating.
- Surfaced experience in CLI and GUI boxer pages and fight result outputs.
- Added save-compatibility behavior to backfill missing `experience_points` on legacy loads.

Files:
- `rules/experience_model.json`
- `boxing_game/modules/experience_engine.py`
- `boxing_game/models.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/fight_sim_engine.py`
- `boxing_game/modules/rating_engine.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_experience_engine.py`
- `tests/test_savegame.py`
- `tests/test_amateur_flow.py`
- `tests/test_pro_career.py`

### 13. Save Management Workflow (CLI + GUI)

- Added save slot operations to the save module:
  - `delete_state(slot)`
  - `rename_state(slot, new_slot)`
  - `duplicate_state(slot, new_slot)`
- Added `list_save_metadata()` to expose save metadata including:
  - last played timestamp (`saved_at`)
  - boxer identity/division/age
  - career month/year and pro/amateur stage
- Updated GUI:
  - existing load flow still supports `Load` / `Delete`
  - added dedicated **Manage Saves** page with `Load`, `Rename`, `Duplicate`, `Delete`
  - added metadata panel for selected save slot
- Updated CLI load flow with selected-slot actions (`Load`, `Delete`, `Back`).
- Added tests for delete, rename, duplicate, and metadata listing behaviors.

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/gui.py`
- `boxing_game/game.py`
- `tests/test_savegame.py`
- `README.md`

### 14. Inline Stat Training Controls (GUI)

- Reworked career layout to place stat-training controls directly to the right of the stats panel.
- Replaced the training-focus dropdown flow with one-click stat buttons (one month per click).
- Removed the generic `Train` action button from the lower action row in favor of direct stat buttons.

Files:
- `boxing_game/gui.py`
- `README.md`

## Tests Added/Updated

### Added assertions/new tests

- Boxer creation rejects empty names.
- Amateur history entries are marked with `stage="amateur"`.
- Amateur opponent generation rejects pro careers.
- Save loader rejects future save versions.
- Legacy save loads infer `career_months` and backfill age.
- `advance_month` rejects negative values.
- Ranking normalization backfills missing organizations.
- Purse breakdown includes and matches `total_expenses`.
- Fight results now grant XP, and legacy saves backfill XP from total fights.
- Added dedicated experience engine tests for levels and gain behavior.
- Added save-management tests for delete/rename/duplicate/metadata operations.

Files:
- `tests/test_player_profile.py`
- `tests/test_amateur_flow.py`
- `tests/test_savegame.py`
- `tests/test_pro_career.py`
- `tests/test_experience_engine.py`

## Validation Performed

- `python3 -m py_compile boxing_game/*.py boxing_game/modules/*.py tests/*.py`
- `PYTHONPATH=./.vendor python3 -m pytest -q`
- CLI smoke run for create -> menu -> quit
- GUI module import smoke check

Result:
- `30 passed` test suite

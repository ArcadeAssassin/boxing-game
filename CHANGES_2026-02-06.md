# Code Audit and Improvements (2026-02-06)

## Scope

Performed a full code pass over CLI, GUI, domain modules, save system, and tests.
Implemented behavior and reliability improvements without changing the core game loop concept.

## Implemented Improvements

### 1. Input and State Validation

- Enforced non-empty boxer names during creation.
- Normalized nationality input (`""` now defaults to `"USA"`).
- Added month-advance validation to reject negative month steps.
- Hardened career state deserialization for invalid month/year values.

Files:
- `boxing_game/modules/player_profile.py`
- `boxing_game/modules/career_clock.py`
- `boxing_game/models.py`

### 2. Legacy Save Migration and Save Compatibility

- Save format now writes `version: 2`.
- Loader now rejects unsupported future save versions with a clear error.
- Added compatibility migration for legacy saves without `career_months`:
  - infers career months from `month/year`
  - backfills age progression baseline from inferred elapsed time

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/models.py`

### 3. Pro Ranking Logic Reliability

- Removed hardcoded rank ceiling assumptions.
- Ranking updates now honor each organization's configured `ranking_slots`.
- Pro ranking state normalization now:
  - backfills missing organizations
  - repairs invalid `organization_focus` on load

Files:
- `boxing_game/modules/pro_career.py`

### 4. Finance/Purse Transparency

- Purse offers now include `total_expenses`.
- Added shared formatter for purse breakdown display.
- Updated CLI and GUI to display expanded purse details.

Files:
- `boxing_game/modules/pro_career.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`

### 5. Amateur/Pro Boundary Guards

- Amateur opponent generation now rejects pro-state careers.
- Existing amateur result guard remains in place.

Files:
- `boxing_game/modules/amateur_circuit.py`

### 6. GUI Startup UX

- Added explicit startup error message when PySide6 is missing, with install command.

Files:
- `boxing_game/gui.py`

### 7. Repository Hygiene

- Added `.gitignore` for Python cache files, virtual env/vendor folders, pytest cache, and local saves.

Files:
- `.gitignore`

### 8. Career Start Age Baseline

- Updated starting boxer age baseline from `18` to `16`.
- Applied baseline consistently to:
  - boxer creation
  - legacy age backfill/migration logic
  - age-related tests

Files:
- `boxing_game/constants.py`
- `boxing_game/modules/player_profile.py`
- `boxing_game/models.py`

### 9. Pro Eligibility Age Gate

- Added `min_age` support to pro readiness rules.
- Configured current gate to allow turning pro from age `19` onward (with fights/points still required).
- Added regression test for age-gated pro readiness.

Files:
- `rules/amateur_progression.json`
- `boxing_game/modules/amateur_circuit.py`
- `tests/test_pro_career.py`

### 10. Save Reliability and Readiness UX

- Save writes now use atomic replacement to reduce corruption risk.
- Save loading now reports clearer, normalized `SavegameError` messages for:
  - invalid JSON
  - invalid version field
  - invalid/malformed career payload
- Added structured readiness status (`age`, `fights`, `points`) and surfaced progress in CLI/GUI.
- Added validation to reject fight simulations with invalid round counts (`< 1`).

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `boxing_game/modules/fight_sim_engine.py`
- `tests/test_savegame.py`
- `tests/test_pro_career.py`
- `tests/test_amateur_flow.py`

### 11. Rankings Page and Boxer Rating

- Added a dedicated GUI rankings page with organization selector (`WBC/WBA/IBF/WBO`) and top-board display.
- Added deterministic ranking snapshot generation with player-row inclusion (ranked/unranked cases).
- Added weighted overall boxer rating and displayed it on boxer profile views.

Files:
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/rating_engine.py`
- `boxing_game/gui.py`
- `boxing_game/game.py`
- `tests/test_pro_career.py`

### 12. Fight Experience Progression

- Added a dedicated experience model (`rules/experience_model.json`) with:
  - stage-specific XP gain (`amateur` vs `pro`)
  - outcome weighting (`win/draw/loss`)
  - KO/TKO bonus
  - configurable level thresholds and in-fight experience bonus
- Added `experience_engine` module for:
  - XP gain calculation
  - XP profile resolution (level/title/next threshold)
  - inferred XP for legacy states using total fight count
- Wired experience gain into both amateur and pro fight-result pipelines.
- Integrated experience bonus into fight simulation and overall rating.
- Surfaced experience in CLI and GUI boxer pages and fight result outputs.
- Added save-compatibility behavior to backfill missing `experience_points` on legacy loads.

Files:
- `rules/experience_model.json`
- `boxing_game/modules/experience_engine.py`
- `boxing_game/models.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/fight_sim_engine.py`
- `boxing_game/modules/rating_engine.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_experience_engine.py`
- `tests/test_savegame.py`
- `tests/test_amateur_flow.py`
- `tests/test_pro_career.py`

### 13. Save Management Workflow (CLI + GUI)

- Added save slot operations to the save module:
  - `delete_state(slot)`
  - `rename_state(slot, new_slot)`
  - `duplicate_state(slot, new_slot)`
- Added `list_save_metadata()` to expose save metadata including:
  - last played timestamp (`saved_at`)
  - boxer identity/division/age
  - career month/year and pro/amateur stage
- Updated GUI:
  - existing load flow still supports `Load` / `Delete`
  - added dedicated **Manage Saves** page with `Load`, `Rename`, `Duplicate`, `Delete`
  - added metadata panel for selected save slot
- Updated CLI load flow with selected-slot actions (`Load`, `Delete`, `Back`).
- Added tests for delete, rename, duplicate, and metadata listing behaviors.

Files:
- `boxing_game/modules/savegame.py`
- `boxing_game/gui.py`
- `boxing_game/game.py`
- `tests/test_savegame.py`
- `README.md`

### 14. Inline Stat Training Controls (GUI)

- Reworked career layout to place stat-training controls directly to the right of the stats panel.
- Replaced the training-focus dropdown flow with one-click stat buttons (one month per click).
- Removed the generic `Train` action button from the lower action row in favor of direct stat buttons.

Files:
- `boxing_game/gui.py`
- `README.md`

### 15. Pro Readiness Rebalance

- Reduced pro readiness requirements to shorten amateur duration before turning pro:
  - `min_fights`: `18` -> `10`
  - `min_points`: `170` -> `100`
- Kept age gate unchanged at `min_age: 19`.

Files:
- `rules/amateur_progression.json`
- `tests/test_pro_career.py`
- `README.md`

### 16. Pro Money Spending Systems

- Added three money-driven gameplay systems in pro career:
  - **Special Training Camp** (costs money, stronger stat growth, higher wear)
  - **Medical Recovery** (costs money, reduces fatigue and injury risk)
  - **Hire/Upgrade Staff**:
    - Elite Coach: passive training focus bonus
    - Nutritionist: passive wear reduction and stronger rest recovery
- Added persistent `injury_risk` on boxer state and integrated it into:
  - training/rest/fight wear loops
  - fight simulation form penalty (via configurable fight-model coefficient)
- Added persistent pro `staff_levels` in save payload.
- Updated CLI and GUI to expose all new pro spending actions and show related status.

Files:
- `rules/pro_spending.json`
- `rules/fight_model.json`
- `boxing_game/modules/pro_spending.py`
- `boxing_game/models.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/fight_sim_engine.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_pro_spending.py`
- `README.md`

### 17. Division Mobility, Lineal Titles, and P4P Rankings

- Added pro **division change** system with adjacent-division movement:
  - immediate lineal vacate on move (if player is lineal champion)
  - down-moves allowed with major fatigue/injury penalties
  - seeded ranking entry in new division based on current pound-for-pound standing
- Added persistent **lineal championship** state by division and defense tracking.
- Added lineal fight resolution in pro fight results:
  - standard vacancy path (`#1 vs #2`)
  - configured fallback path (`#1 vs #3`)
  - capture/defense/loss notes now recorded in fight history
- Expanded sanctioning-body rankings display usage to **top 20**.
- Added **pound-for-pound rankings** generation and player position scoring.
- Upgraded GUI rankings screen:
  - supports WBC/WBA/IBF/WBO and P4P modes
  - table-based, clickable boxer rows
  - detailed boxer panel on row selection
- Added a dedicated **Change Division** action in GUI and CLI pro menus.

Files:
- `boxing_game/modules/pro_career.py`
- `boxing_game/models.py`
- `boxing_game/gui.py`
- `boxing_game/game.py`
- `tests/test_pro_career.py`
- `README.md`

### 18. Real-Life Age Gate and Career Pacing Simulation

- Updated career age baselines:
  - starting age changed to `15`
  - pro minimum age changed to `18`
- Added a reproducible pacing simulator to evaluate fight-count realism under
  fatigue/injury/training decision loops.
- New simulator reports:
  - average amateur/pro/total fights
  - average pro bouts per year
  - pro win rate under balanced vs targeted training policies
  - benchmark check against real-life active-pro bout frequency ranges

Quick reference run:
- `python3 tools/sim_career_pacing.py --runs 120 --retire-age 35`
  - Balanced Training: `2.21` pro bouts/year (inside benchmark)
  - Targeted Training: `2.21` pro bouts/year (inside benchmark)

Files:
- `boxing_game/constants.py`
- `rules/amateur_progression.json`
- `tools/sim_career_pacing.py`
- `README.md`
- `tests/test_pro_career.py`

### 19. In-Game Retirement System

- Added a configurable retirement engine with:
  - hard retirement age cap
  - age-band base retirement probabilities
  - performance-based modifiers (win rate, recent losses, injury risk, fatigue)
  - champion/top-rank protections that reduce retirement chance
- Retirement is now evaluated in-game on monthly progression (CLI + GUI).
- Added retired-career behavior:
  - actions like fight/train/rest are disabled
  - users can still view profile and save the retired career
  - retirement reason/age shown in status views and persisted in saves
- Added save serialization support for retirement fields:
  - `is_retired`
  - `retirement_age`
  - `retirement_reason`

Files:
- `rules/retirement_model.json`
- `boxing_game/modules/retirement_engine.py`
- `boxing_game/models.py`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_retirement_engine.py`
- `tests/test_savegame.py`
- `README.md`

### 20. Dynamic Peak Profiles and Money-Based Aging Extensions

- Added boxer-specific aging profiles with deterministic generation from identity/body metrics:
  - `peak_age`
  - `decline_onset_age`
  - `decline_severity`
  - `iq_growth_factor`
- Wired aging profiles into boxer creation and save serialization/deserialization.
- Added legacy-save backfill path for missing aging profiles.
- Updated birthday aging application:
  - declines are suppressed before each boxerâ€™s personal decline-onset age
  - decline scales by profile severity and years into decline
  - ring-IQ growth scales by profile IQ factor
- Added money extension via `Sports Science Team` staff upgrade:
  - reduces age-related decline magnitude
  - boosts ring-IQ growth factor in aging calculations
- Surfaced aging profile details in CLI/GUI boxer profile panels.

Files:
- `boxing_game/models.py`
- `boxing_game/modules/aging_engine.py`
- `boxing_game/modules/player_profile.py`
- `boxing_game/modules/career_clock.py`
- `boxing_game/modules/pro_spending.py`
- `rules/aging_model.json`
- `rules/pro_spending.json`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_aging_engine.py`
- `tests/test_pro_career.py`
- `tests/test_pro_spending.py`
- `README.md`

### 21. Fight Results Now Affect Post-Fight Wear

- Added a dedicated post-fight aftermath engine that converts fight result details into wear impact:
  - outcome (`win`/`draw`/`loss`)
  - method (`decision` vs `KO/TKO`)
  - rounds completed vs scheduled rounds
- Wired aftermath logic into both amateur and pro fight-result application paths.
- Added configurable `post_fight_effects` to fight rules so balancing can be tuned without code changes.
- Result impact now directly changes fatigue/injury progression, which also feeds retirement risk and pacing.

Files:
- `boxing_game/modules/fight_aftermath.py`
- `boxing_game/modules/amateur_circuit.py`
- `boxing_game/modules/pro_career.py`
- `rules/fight_model.json`
- `tests/test_fight_aftermath.py`
- `tests/test_amateur_flow.py`
- `tests/test_pro_career.py`
- `README.md`

### 22. Multi-Body Sanctioning and Monthly AI World Simulation

- Extended pro fight offers to support **multi-body sanctioning** in one bout.
- Added rule-driven sanctioning policy probabilities in `rules/pro_career.json` so cross-body frequency can be tuned without code edits.
- Opponents now carry per-organization rank context (`WBC/WBA/IBF/WBO`) so a single fight can affect multiple sanctioning bodies.
- Purse offers now include `sanctioning_bodies` and aggregate sanction fees across all bodies involved.
- Pro fight result application now updates rankings for every sanctioned body, not just focus organization.
- Added organization title state by body/division (separate from lineal), with defense tracking and title-transfer handling in sanctioned title fights.
- Division-change flow now vacates any organization titles held in the previous division.
- Added monthly AI world simulation:
  - non-player title movement in the active division
  - player rank drift context when inactive
  - recent world events persisted for CLI/GUI display
- CLI/GUI pro fight prompts now surface opponent multi-body ranks and sanctioned bodies.
- Added a dedicated GUI **World News** panel separated from the main event log.

Files:
- `boxing_game/models.py`
- `boxing_game/modules/pro_career.py`
- `boxing_game/modules/world_sim.py`
- `rules/pro_career.json`
- `boxing_game/game.py`
- `boxing_game/gui.py`
- `tests/test_pro_career.py`
- `tests/test_world_sim.py`
- `README.md`

## Tests Added/Updated

### Added assertions/new tests

- Boxer creation rejects empty names.
- Amateur history entries are marked with `stage="amateur"`.
- Amateur opponent generation rejects pro careers.
- Save loader rejects future save versions.
- Legacy save loads infer `career_months` and backfill age.
- `advance_month` rejects negative values.
- Ranking normalization backfills missing organizations.
- Purse breakdown includes and matches `total_expenses`.
- Fight results now grant XP, and legacy saves backfill XP from total fights.
- Added dedicated experience engine tests for levels and gain behavior.
- Added save-management tests for delete/rename/duplicate/metadata operations.
- Added pro-spending tests for special camp, medical recovery, staff passives, and low-balance guards.
- Added dynamic-aging tests for deterministic profile generation/bounds and legacy-save backfill.
- Added regression tests for decline suppression before boxer-specific onset and sports-science aging modifiers.
- Added result-impact tests for post-fight wear across amateur/pro flows and direct aftermath calculations.
- Added tests for multi-body sanction metadata, cross-body rank updates, and monthly world simulation.

Files:
- `tests/test_player_profile.py`
- `tests/test_amateur_flow.py`
- `tests/test_savegame.py`
- `tests/test_pro_career.py`
- `tests/test_experience_engine.py`
- `tests/test_pro_spending.py`
- `tests/test_aging_engine.py`
- `tests/test_fight_aftermath.py`
- `tests/test_world_sim.py`

## Validation Performed

- `python3 -m py_compile boxing_game/*.py boxing_game/modules/*.py tests/*.py`
- `PYTHONPATH=./.vendor python3 -m pytest -q`
- CLI smoke run for create -> menu -> quit
- GUI module import smoke check

Result:
- `59 passed` test suite
